<!DOCTYPE html>




<html class="theme-next pisces" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
    
  
  <link href="https://cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.min.css" rel="stylesheet" type="text/css" />







  

<link href="https://cdn.bootcss.com/font-awesome/4.6.2/css/font-awesome.min.css" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="CPython3.6源码,PyDictObject," />










<meta name="description" content="参考 python.org文档 PEP412 《Python源码剖析》—— 陈儒  InterfacePython官网把 PyDictObject 归类与 Concrete Objects Layer，享受同样待遇的还有PySetObject。在前面 PythonUnicodeObject 中，我们已经见到了 PythonDict 的运用，即共享机制 interned。在 Python 世界里，字">
<meta name="keywords" content="CPython3.6源码,PyDictObject">
<meta property="og:type" content="article">
<meta property="og:title" content="【CPython3.6源码分析】PyDictObject">
<meta property="og:url" content="http://he11olx.com/2018/07/15/1.4.Python字典对象/index.html">
<meta property="og:site_name" content="Lx&#39;s Blog">
<meta property="og:description" content="参考 python.org文档 PEP412 《Python源码剖析》—— 陈儒  InterfacePython官网把 PyDictObject 归类与 Concrete Objects Layer，享受同样待遇的还有PySetObject。在前面 PythonUnicodeObject 中，我们已经见到了 PythonDict 的运用，即共享机制 interned。在 Python 世界里，字">
<meta property="og:locale" content="zh-Hans">
<meta property="og:updated_time" content="2018-07-21T12:35:05.992Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="【CPython3.6源码分析】PyDictObject">
<meta name="twitter:description" content="参考 python.org文档 PEP412 《Python源码剖析》—— 陈儒  InterfacePython官网把 PyDictObject 归类与 Concrete Objects Layer，享受同样待遇的还有PySetObject。在前面 PythonUnicodeObject 中，我们已经见到了 PythonDict 的运用，即共享机制 interned。在 Python 世界里，字">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":false,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://he11olx.com/2018/07/15/1.4.Python字典对象/"/>





  <title>【CPython3.6源码分析】PyDictObject | Lx's Blog</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Lx's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <h1 class="site-subtitle" itemprop="description">Hello world!</h1>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br />
            
            归档
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="搜索..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://he11olx.com/2018/07/15/1.4.Python字典对象/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="He11oLx">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://avatars3.githubusercontent.com/u/41121010?s=460&v=4">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Lx's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">【CPython3.6源码分析】PyDictObject</h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-07-15T22:00:00+08:00">
                2018-07-15
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Python/" itemprop="url" rel="index">
                    <span itemprop="name">Python</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/07/15/1.4.Python字典对象/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2018/07/15/1.4.Python字典对象/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          
            <span class="post-meta-divider">|</span>
            <span class="page-pv"><i class="fa fa-file-o">本文总阅读量</i>
            <span class="busuanzi-value" id="busuanzi_value_page_pv" ></span>次
            </span>
          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul>
<li><a href="https://docs.python.org/3.6/c-api/dict.html" target="_blank" rel="noopener">python.org文档</a></li>
<li><a href="https://www.python.org/dev/peps/pep-0412/" target="_blank" rel="noopener">PEP412</a></li>
<li>《Python源码剖析》—— 陈儒</li>
</ul>
<h2 id="Interface"><a href="#Interface" class="headerlink" title="Interface"></a>Interface</h2><p>Python官网把 PyDictObject 归类与 <code>Concrete Objects Layer</code>，享受同样待遇的还有<code>PySetObject</code>。在前面 PythonUnicodeObject 中，我们已经见到了 PythonDict 的运用，即共享机制 interned。在 Python 世界里，字典被用于建立字节码的运行环境，用来存放变量名和变量值，意味着做任何操作几乎都要设计到 PythonDict，</p>
<p>因此，对搜索的效率要求及其苛刻。因而采用的 HashTable(散列表)，在最优情况下能达到O(1)。散列表的基本思想是，将键映射为一个整数，把整数作为索引访问内存。主要逻辑是：查询键值 ——散列函数 hash function —— 散列值 hash value —— 内存区域 —— 查询结果——散列冲突。Python 处理散列冲突的问题，采用的是 开放定址法。删除探测链上元素，采用的是伪删除。<br><a id="more"></a></p>
<p>因为字典的重要性，Python 甚至单独在<code>Objects/dictnotes.txt</code>中写入了关于字典的说明，下面仅挑选部分内容：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">1. 主要应用</span><br><span class="line">    1. 传递关键字参数（1~3个元素）</span><br><span class="line">    2. 类方法查找：</span><br><span class="line">        1. 通常包含 8~16 个元素。</span><br><span class="line">        2. 通常只写入一次，但多次查找</span><br><span class="line">        3. 当使用基类时，会频繁在基类中查找</span><br><span class="line">    3. 实例属性查找、全局变量查找</span><br><span class="line">        1. 通常包含 4~10 个元素。</span><br><span class="line">        2. 写入和读取都非常频繁</span><br><span class="line">    4. Builtins（内置命令）</span><br><span class="line">        1. 频繁的读取，几乎不写入</span><br><span class="line">        2. About 150 interned strings (as of Py3.3).</span><br><span class="line">        3. 其中一切访问频率远大于其他</span><br><span class="line"></span><br><span class="line">2. 数据存储</span><br><span class="line">   由3部分组成：</span><br><span class="line">       1. dictobject 自身</span><br><span class="line">       2. A dict-keys object (keys &amp; hashes)</span><br><span class="line">       3. A values array</span><br><span class="line"></span><br><span class="line">仅涉及单个键的字典操作可以是O（1），除非涉及到调整大小。</span><br><span class="line"></span><br><span class="line">现在的版本与之前的差别：</span><br><span class="line">    1. key value 可以分开存储</span><br><span class="line">    2. 分离表中 key-val 新增组合 (key, NULL)，代表被删除</span><br><span class="line">    3. key-val表中，不能嵌套小表</span><br><span class="line">    4. 一般字典比以前略大</span><br><span class="line">    5. 单个类的所有对象，共享key表，节约大量内存</span><br></pre></td></tr></table></figure></p>
<h2 id="PyDict-Type"><a href="#PyDict-Type" class="headerlink" title="PyDict_Type"></a>PyDict_Type</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// dictobject.c.3282</span></span><br><span class="line">PyTypeObject PyDict_Type = &#123;</span><br><span class="line">    PyVarObject_HEAD_INIT(&amp;PyType_Type, <span class="number">0</span>)</span><br><span class="line">    <span class="string">"dict"</span>,</span><br><span class="line">    <span class="keyword">sizeof</span>(PyDictObject),</span><br><span class="line">    (destructor)dict_dealloc,                   <span class="comment">/* tp_dealloc */</span></span><br><span class="line">    &amp;dict_as_sequence,                          <span class="comment">/* tp_as_sequence */</span></span><br><span class="line">    &amp;dict_as_mapping,                           <span class="comment">/* tp_as_mapping */</span></span><br><span class="line">    PyObject_HashNotImplemented,                <span class="comment">/* tp_hash */</span></span><br><span class="line">    (getiterfunc)dict_iter,                     <span class="comment">/* tp_iter */</span></span><br><span class="line">    mapp_methods,                               <span class="comment">/* tp_methods */</span></span><br><span class="line">    dict_init,                                  <span class="comment">/* tp_init */</span></span><br><span class="line">    PyType_GenericAlloc,                        <span class="comment">/* tp_alloc */</span></span><br><span class="line">    dict_new,                                   <span class="comment">/* tp_new */</span></span><br><span class="line">    PyObject_GC_Del,                            <span class="comment">/* tp_free */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h2 id="PyDictObject"><a href="#PyDictObject" class="headerlink" title="PyDictObject"></a>PyDictObject</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// dictobject.h.18</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">dictkeysobject</span> <span class="title">PyDictKeysObject</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    PyObject_HEAD</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Number of items in the dictionary */</span></span><br><span class="line">    Py_ssize_t ma_used;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Dictionary version: globally unique,</span></span><br><span class="line"><span class="comment">       value change each time the dictionary is modified */</span></span><br><span class="line">    <span class="keyword">uint64_t</span> ma_version_tag;</span><br><span class="line"></span><br><span class="line">    PyDictKeysObject *ma_keys;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* If ma_values is NULL, the table is "combined":</span></span><br><span class="line"><span class="comment">            keys and values are stored in ma_keys.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">       If ma_values is not NULL, the table is splitted:</span></span><br><span class="line"><span class="comment">           keys are stored in ma_keys and values are stored in ma_values</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">    PyObject **ma_values;</span><br><span class="line">&#125; PyDictObject;</span><br></pre></td></tr></table></figure>
<p>如上，不同于之前的 PyListObject/PyUnicodeObject，他们被归类于 Sequence Object。而PyDictObject 归类于 Concrete Objects。因此，直接定义为 <code>PyObject_HEAD</code>。其他字段含义，见注释。</p>
<p>既然是分离设计，那么必然存在两个储存表的地方，一个是 ma_keys，一个是ma_values。具体内容见下文注释。<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">The DictObject can be in one of two forms.</span><br><span class="line"></span><br><span class="line">A combined table:</span><br><span class="line">    ma_values == <span class="literal">NULL</span>, dk_refcnt == <span class="number">1.</span></span><br><span class="line">    Values are stored in the me_value field of the PyDictKeysObject.</span><br><span class="line"></span><br><span class="line">A split table:</span><br><span class="line">    ma_values != <span class="literal">NULL</span>, dk_refcnt &gt;= <span class="number">1</span></span><br><span class="line">    Values are stored in the ma_values <span class="built_in">array</span>.</span><br><span class="line">    Only <span class="built_in">string</span> (unicode) keys are allowed.</span><br><span class="line">    All dicts sharing same key must have same insertion order.</span><br></pre></td></tr></table></figure></p>
<h2 id="PyDictKeysObject"><a href="#PyDictKeysObject" class="headerlink" title="PyDictKeysObject"></a>PyDictKeysObject</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// dict-common.h/23</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">dictkeysobject</span> &#123;</span></span><br><span class="line">    Py_ssize_t dk_refcnt;</span><br><span class="line">    Py_ssize_t dk_size;</span><br><span class="line">    dict_lookup_func dk_lookup;</span><br><span class="line">    Py_ssize_t dk_usable;</span><br><span class="line">    Py_ssize_t dk_nentries;</span><br><span class="line">    <span class="keyword">union</span> &#123;</span><br><span class="line">        <span class="keyword">int8_t</span> as_1[<span class="number">8</span>];</span><br><span class="line">        <span class="keyword">int16_t</span> as_2[<span class="number">4</span>];</span><br><span class="line">        <span class="keyword">int32_t</span> as_4[<span class="number">2</span>];</span><br><span class="line">        <span class="keyword">int64_t</span> as_8[<span class="number">1</span>];</span><br><span class="line">    &#125; dk_indices;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>PyDictKeysObject 实现了字典的 hash table，布局如下:</p>
<h3 id="layout"><a href="#layout" class="headerlink" title="layout"></a>layout</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">+---------------+</span><br><span class="line">| dk_refcnt     |</span><br><span class="line">| dk_size       |  <span class="comment">/* Size of the hash table.</span></span><br><span class="line"><span class="comment">|               |    It must be a power of 2. */</span></span><br><span class="line">| dk_lookup     |   <span class="comment">/* Function to lookup in the hash table. */</span></span><br><span class="line">| dk_usable     |   <span class="comment">/* Number of usable entries in dk_entries. */</span></span><br><span class="line">| dk_nentries   |   <span class="comment">/* Number of used entries in dk_entries. */</span></span><br><span class="line">+---------------+</span><br><span class="line">| dk_indices    |   <span class="comment">// Actual hash table of dk_size entries.</span></span><br><span class="line">|               |</span><br><span class="line">+---------------+</span><br><span class="line">| dk_entries    |   <span class="comment">/* array of PyDictKeyEntry.</span></span><br><span class="line"><span class="comment">|               |      len(dk_entries) == USABLE_FRACTION(dk_size) */</span></span><br><span class="line">+---------------+</span><br><span class="line"></span><br><span class="line">The size in bytes of an indice depends on dk_size:</span><br><span class="line"></span><br><span class="line">- <span class="number">1</span> byte <span class="keyword">if</span> dk_size &lt;= <span class="number">0xff</span> (<span class="keyword">char</span>*)</span><br><span class="line">- <span class="number">2</span> bytes <span class="keyword">if</span> dk_size &lt;= <span class="number">0xffff</span> (<span class="keyword">int16_t</span>*)</span><br><span class="line">- <span class="number">4</span> bytes <span class="keyword">if</span> dk_size &lt;= <span class="number">0xffffffff</span> (<span class="keyword">int32_t</span>*)</span><br><span class="line">- <span class="number">8</span> bytes otherwise (<span class="keyword">int64_t</span>*)</span><br><span class="line"></span><br><span class="line">Dynamically sized, <span class="number">8</span> is minimum.</span><br></pre></td></tr></table></figure>
<p>需要注意的是，dk_indices 是一个共用体，会根据 dk_size 的值，决定存储 index 的类型。</p>
<h3 id="PyDictKeyEntry"><a href="#PyDictKeyEntry" class="headerlink" title="PyDictKeyEntry"></a>PyDictKeyEntry</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// dict-common.h.17</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DKIX_EMPTY (-1)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DKIX_DUMMY (-2)  <span class="comment">/* Used internally */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DKIX_ERROR (-3)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// dict-common.h.4</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    Py_hash_t me_hash;  <span class="comment">/* Cached hash code of me_key. */</span></span><br><span class="line">    PyObject *me_key;</span><br><span class="line">    PyObject *me_value; <span class="comment">/* only meaningful for combined tables */</span></span><br><span class="line">&#125; PyDictKeyEntry;</span><br></pre></td></tr></table></figure>
<p>dk_entries中存储的是 PyDictKeyEntry对象，其中每个元素都可以称为一个 enrty。因为使用了负数作为 entry 的状态，因此<code>dk_indices</code>中存储的是有符号整数。可以通过 宏 DK_ENTRIES 访问 entry：<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// dictobject.c.289</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DK_SIZE(dk) ((dk)-&gt;dk_size)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DK_IXSIZE(dk)                          \</span></span><br><span class="line">    (DK_SIZE(dk) &lt;= <span class="number">0xff</span> ?                     \</span><br><span class="line">        <span class="number">1</span> : DK_SIZE(dk) &lt;= <span class="number">0xffff</span> ?            \</span><br><span class="line">            <span class="number">2</span> : DK_SIZE(dk) &lt;= <span class="number">0xffffffff</span> ?    \</span><br><span class="line">                <span class="number">4</span> : <span class="keyword">sizeof</span>(<span class="keyword">int64_t</span>))</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DK_ENTRIES(dk) \</span></span><br><span class="line">    ((PyDictKeyEntry*)(&amp;(dk)-&gt;dk_indices.as_1[DK_SIZE(dk) * DK_IXSIZE(dk)]))</span><br></pre></td></tr></table></figure></p>
<h3 id="dk-indices"><a href="#dk-indices" class="headerlink" title="dk_indices"></a>dk_indices</h3><p>dk_indices 即是真正的 hash table，对应一个 slot 数组，每个slot 有四种状态<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// dictobject.c.64</span></span><br><span class="line"><span class="number">1.</span> Unused.  index == DKIX_EMPTY</span><br><span class="line">   This is each slot's initial state.</span><br><span class="line">   Does <span class="keyword">not</span> hold an active (key, value) pair now <span class="keyword">and</span> never did.</span><br><span class="line">   Unused can transition to Active upon key insertion.</span><br><span class="line"></span><br><span class="line"><span class="number">2.</span> Active.  index &gt;= <span class="number">0</span>, me_key != <span class="literal">NULL</span> <span class="keyword">and</span> me_value != <span class="literal">NULL</span></span><br><span class="line">   Holds an active (key, value) pair.</span><br><span class="line">   This is the only <span class="keyword">case</span> in which me_value != <span class="literal">NULL</span>.</span><br><span class="line">   Active can transition to Dummy <span class="keyword">or</span> Pending upon key deletion~~~~</span><br><span class="line">   (<span class="keyword">for</span> combined <span class="keyword">and</span> split tables respectively).</span><br><span class="line"></span><br><span class="line"><span class="number">3.</span> Dummy.  index == DKIX_DUMMY  (combined only)</span><br><span class="line">   Previously held an active (key, value) pair,</span><br><span class="line">   but that was deleted <span class="keyword">and</span> an active pair has <span class="keyword">not</span> yet overwritten the slot.</span><br><span class="line">   Dummy can transition to Active upon key insertion.</span><br><span class="line">   Dummy slots cannot be made Unused again.</span><br><span class="line"></span><br><span class="line"><span class="number">4.</span> Pending. index &gt;= <span class="number">0</span>, key != <span class="literal">NULL</span>, <span class="keyword">and</span> value == <span class="literal">NULL</span>  (split only)</span><br><span class="line">   Not yet inserted in split-table.</span><br></pre></td></tr></table></figure></p>
<p>简单来说就是</p>
<ol>
<li>Unused，初始状态，该 slot 没有被使用，index = -1</li>
<li>Active，正在使用，index &gt; 0</li>
<li>Dummy，曾经使用过，但现在被删除了，index = -2 。(仅限 combined-table)</li>
<li>Pending，还未插入。(仅限 split-table)<br>正因为 Dummy 态不能转换为 Unused，所以保证了探测链的连续性，对应前文说的 伪删除。</li>
</ol>
<h2 id="创建"><a href="#创建" class="headerlink" title="创建"></a>创建</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PyDict_MINSIZE 8</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// dictobject.c.620</span></span><br><span class="line"><span class="function">PyObject * <span class="title">PyDict_New</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    PyDictKeysObject *keys = new_keys_object(PyDict_MINSIZE);</span><br><span class="line">    <span class="keyword">if</span> (keys == <span class="literal">NULL</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">return</span> new_dict(keys, <span class="literal">NULL</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>PyDict_MINSIZE 是任何新 Dict 的起始大小，默认为8，满足运行过程中大量的函数参数传递过程。</p>
<h3 id="new-keys-object"><a href="#new-keys-object" class="headerlink" title="new_keys_object"></a>new_keys_object</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// dictobject.c.374</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> USABLE_FRACTION(n) (((n) &lt;&lt; 1)/3)</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> PyDictKeysObject *<span class="title">new_keys_object</span><span class="params">(Py_ssize_t size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    PyDictKeysObject *dk;</span><br><span class="line">    Py_ssize_t es, usable;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// dk_size &gt;= 8  and must be a power of 2.</span></span><br><span class="line">    assert(size &gt;= PyDict_MINSIZE);</span><br><span class="line">    assert(IS_POWER_OF_2(size));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// len(dk_entries) == USABLE_FRACTION(dk_size)，最小为5</span></span><br><span class="line">    usable = USABLE_FRACTION(size);</span><br><span class="line">        ...  <span class="comment">// es = 1/2/3/4;  根据 size 大小，确定存储位数</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 尝试共享</span></span><br><span class="line">    <span class="keyword">if</span> (size == PyDict_MINSIZE &amp;&amp; numfreekeys &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        dk = keys_free_list[--numfreekeys];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        dk = PyObject_MALLOC(<span class="keyword">sizeof</span>(PyDictKeysObject)</span><br><span class="line">                             - Py_MEMBER_SIZE(PyDictKeysObject, dk_indices)</span><br><span class="line">                             + es * size</span><br><span class="line">                             + <span class="keyword">sizeof</span>(PyDictKeyEntry) * usable);</span><br><span class="line">        <span class="keyword">if</span> (dk == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            PyErr_NoMemory();</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    DK_DEBUG_INCREF dk-&gt;dk_refcnt = <span class="number">1</span>;</span><br><span class="line">    dk-&gt;dk_size = size;</span><br><span class="line">    dk-&gt;dk_usable = usable;</span><br><span class="line">    dk-&gt;dk_lookup = lookdict_unicode_nodummy;</span><br><span class="line">    dk-&gt;dk_nentries = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 初始化 dk_indices == -1</span></span><br><span class="line">    <span class="built_in">memset</span>(&amp;dk-&gt;dk_indices.as_1[<span class="number">0</span>], <span class="number">0xff</span>, es * size);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 初始化 dk_entries == 0</span></span><br><span class="line">    <span class="built_in">memset</span>(DK_ENTRIES(dk), <span class="number">0</span>, <span class="keyword">sizeof</span>(PyDictKeyEntry) * usable);</span><br><span class="line">    <span class="keyword">return</span> dk;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>从代码中也清晰的看见，对象缓冲池 keys_free_list 的身影。其中需要注意的是：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">usable = USABLE_FRACTION(size);    // (((n) &lt;&lt; 1)/3)</span><br></pre></td></tr></table></figure>
<p>size 默认为 PyDict_MINSIZE 即8。通过计算可以得出默认存放5个对象。</p>
<h3 id="new-dict"><a href="#new-dict" class="headerlink" title="new_dict"></a>new_dict</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// dictobject.c.573</span></span><br><span class="line"><span class="keyword">static</span> PyObject *</span><br><span class="line">new_dict(PyDictKeysObject *keys, PyObject **values)</span><br><span class="line">&#123;</span><br><span class="line">    PyDictObject *mp;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 尝试共享</span></span><br><span class="line">    <span class="keyword">if</span> (numfree) &#123;</span><br><span class="line">        mp = free_list[--numfree];</span><br><span class="line">        _Py_NewReference((PyObject *)mp);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        mp = PyObject_GC_New(PyDictObject, &amp;PyDict_Type);</span><br><span class="line">        <span class="keyword">if</span> (mp == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            DK_DECREF(keys);</span><br><span class="line">            free_values(values);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    mp-&gt;ma_keys = keys;</span><br><span class="line">    mp-&gt;ma_values = values;</span><br><span class="line">    mp-&gt;ma_used = <span class="number">0</span>;</span><br><span class="line">    mp-&gt;ma_version_tag = DICT_NEXT_VERSION();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> (PyObject *)mp;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>代码不长，很好懂。再次发现了对象池 free_list。</p>
<h2 id="共享机制"><a href="#共享机制" class="headerlink" title="共享机制"></a>共享机制</h2><p>前面 创建 PyDictObject  和 PyDictKeysObject 时，都利用了对象缓冲池。<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PyDict_MAXFREELIST 80</span></span><br><span class="line"><span class="keyword">static</span> PyDictObject *free_list[PyDict_MAXFREELIST];</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">int</span> numfree = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">static</span> PyDictKeysObject *keys_free_list[PyDict_MAXFREELIST];</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">int</span> numfreekeys = <span class="number">0</span>;</span><br></pre></td></tr></table></figure></p>
<p>宏定义如上，与 PyListObject 类似，甚至连名字都类似。那么必然的，销毁对象时，会把对象放入缓冲池。</p>
<h3 id="dict-dealloc"><a href="#dict-dealloc" class="headerlink" title="dict_dealloc"></a>dict_dealloc</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> PyObject *empty_values[<span class="number">1</span>] = &#123; <span class="literal">NULL</span> &#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// dictobject.c.2003</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">dict_dealloc</span><span class="params">(PyDictObject *mp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    PyObject **values = mp-&gt;ma_values;</span><br><span class="line">    PyDictKeysObject *keys = mp-&gt;ma_keys;</span><br><span class="line">    Py_ssize_t i, n;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* bpo-31095: UnTrack is needed before calling any callbacks */</span></span><br><span class="line">    PyObject_GC_UnTrack(mp);</span><br><span class="line">    Py_TRASHCAN_SAFE_BEGIN(mp)</span><br><span class="line">    <span class="keyword">if</span> (values != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (values != empty_values) &#123;</span><br><span class="line">            <span class="keyword">for</span> (i = <span class="number">0</span>, n = mp-&gt;ma_keys-&gt;dk_nentries; i &lt; n; i++) &#123;</span><br><span class="line">                Py_XDECREF(values[i]);</span><br><span class="line">            &#125;</span><br><span class="line">            free_values(values);</span><br><span class="line">        &#125;</span><br><span class="line">        DK_DECREF(keys);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (keys != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        assert(keys-&gt;dk_refcnt == <span class="number">1</span>);</span><br><span class="line">        DK_DECREF(keys);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//　尝试共享</span></span><br><span class="line">    <span class="keyword">if</span> (numfree &lt; PyDict_MAXFREELIST &amp;&amp; Py_TYPE(mp) == &amp;PyDict_Type)</span><br><span class="line">        free_list[numfree++] = mp;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        Py_TYPE(mp)-&gt;tp_free((PyObject *)mp);</span><br><span class="line">    Py_TRASHCAN_SAFE_END(mp)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// dictobject.c.554</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">free_keys_object</span><span class="params">(PyDictKeysObject *keys)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    PyDictKeyEntry *entries = DK_ENTRIES(keys);</span><br><span class="line">    Py_ssize_t i, n;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>, n = keys-&gt;dk_nentries; i &lt; n; i++) &#123;</span><br><span class="line">        Py_XDECREF(entries[i].me_key);</span><br><span class="line">        Py_XDECREF(entries[i].me_value);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//　尝试共享</span></span><br><span class="line">    <span class="keyword">if</span> (keys-&gt;dk_size == PyDict_MINSIZE &amp;&amp; numfreekeys &lt; PyDict_MAXFREELIST) &#123;</span><br><span class="line">        keys_free_list[numfreekeys++] = keys;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    PyObject_FREE(keys);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="CRUD"><a href="#CRUD" class="headerlink" title="CRUD"></a>CRUD</h2><h3 id="Mapping方法簇"><a href="#Mapping方法簇" class="headerlink" title="Mapping方法簇"></a>Mapping方法簇</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> PyMappingMethods dict_as_mapping = &#123;</span><br><span class="line">    (lenfunc)dict_length, <span class="comment">/*mp_length*/</span></span><br><span class="line">    (binaryfunc)dict_subscript, <span class="comment">/*mp_subscript*/</span></span><br><span class="line">    (objobjargproc)dict_ass_sub, <span class="comment">/*mp_ass_subscript*/</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> Py_ssize_t <span class="title">dict_length</span><span class="params">(PyDictObject *mp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> mp-&gt;ma_used;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>PyDict_Type 中定义的 tp_as_mapping == &amp;dict_as_mapping。从代码中可以看见<code>len(dict)</code>时间复杂度为O(1)。执行 dict[item] 即调用 dict_subscript()。</p>
<h3 id="GetItem"><a href="#GetItem" class="headerlink" title="GetItem"></a>GetItem</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// dictobject.c.2172</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> PyObject * <span class="title">dict_subscript</span><span class="params">(PyDictObject *mp, PyObject *key)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    PyObject *v;</span><br><span class="line">    Py_ssize_t ix;</span><br><span class="line">    Py_hash_t hash;</span><br><span class="line">    PyObject **value_addr;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 1. 获取/计算 hash 值</span></span><br><span class="line">    <span class="keyword">if</span> (!PyUnicode_CheckExact(key) ||</span><br><span class="line">        (hash = ((PyASCIIObject *) key)-&gt;hash) == <span class="number">-1</span>) &#123;</span><br><span class="line">        hash = PyObject_Hash(key);</span><br><span class="line">        <span class="keyword">if</span> (hash == <span class="number">-1</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 2. 查找 index ，返回 ix&gt;0  或 ix == -1 / -3</span></span><br><span class="line">    ix = (mp-&gt;ma_keys-&gt;dk_lookup)(mp, key, hash, &amp;value_addr, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">if</span> (ix == DKIX_ERROR)    <span class="comment">// -3</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3. 根据 ix 结果值，执行 __miss__ 或 返回结果</span></span><br><span class="line">    <span class="keyword">if</span> (ix == DKIX_EMPTY || *value_addr == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!PyDict_CheckExact(mp)) &#123;</span><br><span class="line">            <span class="comment">/* Look up __missing__ method if we're a subclass. */</span></span><br><span class="line">            PyObject *missing, *res;</span><br><span class="line">            _Py_IDENTIFIER(__missing__);</span><br><span class="line">            missing = _PyObject_LookupSpecial((PyObject *)mp, &amp;PyId___missing__);</span><br><span class="line">            <span class="keyword">if</span> (missing != <span class="literal">NULL</span>) &#123;</span><br><span class="line">                res = PyObject_CallFunctionObjArgs(missing,</span><br><span class="line">                                                   key, <span class="literal">NULL</span>);</span><br><span class="line">                Py_DECREF(missing);</span><br><span class="line">                <span class="keyword">return</span> res;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (PyErr_Occurred())</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        _PyErr_SetKeyError(key);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    v = *value_addr;</span><br><span class="line">    Py_INCREF(v);</span><br><span class="line">    <span class="keyword">return</span> v;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>源码如上，需要注意的的是，返回的是 对象引用。并且，时间复杂度为O(1)。</p>
<p>ix 获取方式 <code>mp-&gt;ma_keys-&gt;dk_lookup</code>，即调用 PyDictObject 自身的 dk_lookup，在前面的 PyDict_New 中，可以发现 dk-&gt;dk_lookup = lookdict_unicode_nodummy。实际上，dk_lookup 存在不止一种。</p>
<h4 id="dk-lookup"><a href="#dk-lookup" class="headerlink" title="dk_lookup"></a>dk_lookup</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ictobject.c.224</span></span><br><span class="line"><span class="comment">/* lookdict() is general-purpose, and may return DKIX_ERROR if (and only if) a</span></span><br><span class="line"><span class="comment">   comparison raises an exception. */</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> Py_ssize_t <span class="title">lookdict</span><span class="params">(PyDictObject *mp, PyObject *key,</span></span></span><br><span class="line"><span class="function"><span class="params">                           Py_hash_t hash, PyObject ***value_addr,</span></span></span><br><span class="line"><span class="function"><span class="params">                           Py_ssize_t *hashpos)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Specialized version for string-only keys */</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> Py_ssize_t <span class="title">lookdict_unicode</span><span class="params">(PyDictObject *mp, PyObject *key,</span></span></span><br><span class="line"><span class="function"><span class="params">                                   Py_hash_t hash, PyObject ***value_addr,</span></span></span><br><span class="line"><span class="function"><span class="params">                                     Py_ssize_t *hashpos)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Faster version of lookdict_unicode when it is known that no &lt;dummy&gt; keys</span></span><br><span class="line"><span class="comment"> * will be present. */</span></span><br><span class="line"><span class="keyword">static</span> Py_ssize_t</span><br><span class="line">lookdict_unicode_nodummy(PyDictObject *mp, PyObject *key,</span><br><span class="line">                         Py_hash_t hash, PyObject ***value_addr,</span><br><span class="line">                         Py_ssize_t *hashpos);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Version of lookdict for split tables.</span></span><br><span class="line"><span class="comment"> * All split tables and only split tables use this lookup function.</span></span><br><span class="line"><span class="comment"> * Split tables only contain unicode keys and no dummy keys,</span></span><br><span class="line"><span class="comment"> * so algorithm is the same as lookdict_unicode_nodummy.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> Py_ssize_t <span class="title">lookdict_split</span><span class="params">(PyDictObject *mp, PyObject *key,</span></span></span><br><span class="line"><span class="function"><span class="params">                                 Py_hash_t hash, PyObject ***value_addr,</span></span></span><br><span class="line"><span class="function"><span class="params">                                 Py_ssize_t *hashpos)</span></span>;</span><br></pre></td></tr></table></figure>
<p>如上，dk_lookup 有4个非常相似的 查找函数。因为在 Python 中，大量使用 str 作为字典的 key，因此会有2个特定针对 str 对象的 优化版本。</p>
<h4 id="lookdict"><a href="#lookdict" class="headerlink" title="lookdict"></a>lookdict</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> Py_ssize_t</span><br><span class="line">lookdict(PyDictObject *mp, PyObject *key,</span><br><span class="line">         Py_hash_t hash, PyObject ***value_addr, Py_ssize_t *hashpos)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">size_t</span> i, mask;</span><br><span class="line">    Py_ssize_t ix, freeslot;</span><br><span class="line">    <span class="keyword">int</span> cmp;</span><br><span class="line">    PyDictKeysObject *dk;</span><br><span class="line">    PyDictKeyEntry *ep0, *ep;</span><br><span class="line">    PyObject *startkey;</span><br><span class="line"></span><br><span class="line">top:</span><br><span class="line">    dk = mp-&gt;ma_keys;</span><br><span class="line">    mask = DK_MASK(dk);</span><br><span class="line">    ep0 = DK_ENTRIES(dk);</span><br><span class="line">    i = (<span class="keyword">size_t</span>)hash &amp; mask;</span><br><span class="line"></span><br><span class="line">    ix = dk_get_index(dk, i);</span><br><span class="line">    <span class="keyword">if</span> (ix == DKIX_EMPTY) &#123;</span><br><span class="line">        <span class="keyword">if</span> (hashpos != <span class="literal">NULL</span>)</span><br><span class="line">            *hashpos = i;</span><br><span class="line">        *value_addr = <span class="literal">NULL</span>;</span><br><span class="line">        <span class="keyword">return</span> DKIX_EMPTY;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (ix == DKIX_DUMMY) &#123;</span><br><span class="line">        freeslot = i;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        ep = &amp;ep0[ix];</span><br><span class="line">        assert(ep-&gt;me_key != <span class="literal">NULL</span>);</span><br><span class="line">        <span class="keyword">if</span> (ep-&gt;me_key == key) &#123;</span><br><span class="line">            *value_addr = &amp;ep-&gt;me_value;</span><br><span class="line">            <span class="keyword">if</span> (hashpos != <span class="literal">NULL</span>)</span><br><span class="line">                *hashpos = i;</span><br><span class="line">            <span class="keyword">return</span> ix;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (ep-&gt;me_hash == hash) &#123;</span><br><span class="line">            startkey = ep-&gt;me_key;</span><br><span class="line">            Py_INCREF(startkey);</span><br><span class="line">            cmp = PyObject_RichCompareBool(startkey, key, Py_EQ);</span><br><span class="line">            Py_DECREF(startkey);</span><br><span class="line">            <span class="keyword">if</span> (cmp &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                *value_addr = <span class="literal">NULL</span>;</span><br><span class="line">                <span class="keyword">return</span> DKIX_ERROR;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (dk == mp-&gt;ma_keys &amp;&amp; ep-&gt;me_key == startkey) &#123;</span><br><span class="line">                <span class="keyword">if</span> (cmp &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                    *value_addr = &amp;ep-&gt;me_value;</span><br><span class="line">                    <span class="keyword">if</span> (hashpos != <span class="literal">NULL</span>)</span><br><span class="line">                        *hashpos = i;</span><br><span class="line">                    <span class="keyword">return</span> ix;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">/* The dict was mutated, restart */</span></span><br><span class="line">                <span class="keyword">goto</span> top;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        freeslot = <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">size_t</span> perturb = hash;;) &#123;</span><br><span class="line">        perturb &gt;&gt;= PERTURB_SHIFT;</span><br><span class="line">        i = ((i &lt;&lt; <span class="number">2</span>) + i + perturb + <span class="number">1</span>) &amp; mask;</span><br><span class="line">        ix = dk_get_index(dk, i);</span><br><span class="line">        <span class="keyword">if</span> (ix == DKIX_EMPTY) &#123;</span><br><span class="line">            <span class="keyword">if</span> (hashpos != <span class="literal">NULL</span>) &#123;</span><br><span class="line">                *hashpos = (freeslot == <span class="number">-1</span>) ? (Py_ssize_t)i : freeslot;</span><br><span class="line">            &#125;</span><br><span class="line">            *value_addr = <span class="literal">NULL</span>;</span><br><span class="line">            <span class="keyword">return</span> ix;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (ix == DKIX_DUMMY) &#123;</span><br><span class="line">            <span class="keyword">if</span> (freeslot == <span class="number">-1</span>)</span><br><span class="line">                freeslot = i;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        ep = &amp;ep0[ix];</span><br><span class="line">        assert(ep-&gt;me_key != <span class="literal">NULL</span>);</span><br><span class="line">        <span class="keyword">if</span> (ep-&gt;me_key == key) &#123;</span><br><span class="line">            <span class="keyword">if</span> (hashpos != <span class="literal">NULL</span>) &#123;</span><br><span class="line">                *hashpos = i;</span><br><span class="line">            &#125;</span><br><span class="line">            *value_addr = &amp;ep-&gt;me_value;</span><br><span class="line">            <span class="keyword">return</span> ix;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (ep-&gt;me_hash == hash) &#123;</span><br><span class="line">            startkey = ep-&gt;me_key;</span><br><span class="line">            Py_INCREF(startkey);</span><br><span class="line">            cmp = PyObject_RichCompareBool(startkey, key, Py_EQ);</span><br><span class="line">            Py_DECREF(startkey);</span><br><span class="line">            <span class="keyword">if</span> (cmp &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                *value_addr = <span class="literal">NULL</span>;</span><br><span class="line">                <span class="keyword">return</span> DKIX_ERROR;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (dk == mp-&gt;ma_keys &amp;&amp; ep-&gt;me_key == startkey) &#123;</span><br><span class="line">                <span class="keyword">if</span> (cmp &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (hashpos != <span class="literal">NULL</span>) &#123;</span><br><span class="line">                        *hashpos = i;</span><br><span class="line">                    &#125;</span><br><span class="line">                    *value_addr = &amp;ep-&gt;me_value;</span><br><span class="line">                    <span class="keyword">return</span> ix;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">/* The dict was mutated, restart */</span></span><br><span class="line">                <span class="keyword">goto</span> top;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    assert(<span class="number">0</span>);          <span class="comment">/* NOT REACHED */</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如上，通用的 lookdict 代码很长。大概可以分为 以下几部分</p>
<h5 id="ix"><a href="#ix" class="headerlink" title="ix = ?"></a>ix = ?</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DK_MASK(dk) (((dk)-&gt;dk_size)-1)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> Py_ssize_t</span><br><span class="line">lookdict(PyDictObject *mp, PyObject *key,</span><br><span class="line">         Py_hash_t hash, PyObject ***value_addr, Py_ssize_t *hashpos)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">size_t</span> i, mask;</span><br><span class="line">    PyDictKeysObject *dk;</span><br><span class="line"></span><br><span class="line">    dk = mp-&gt;ma_keys;</span><br><span class="line">    mask = DK_MASK(dk);</span><br><span class="line">    i = (<span class="keyword">size_t</span>)hash &amp; mask;    <span class="comment">// hash%dk_size == hash &amp; (dk_size - 1)</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>前面已经知道：</p>
<ul>
<li>hash == PyObject_Hash(key)</li>
<li>dk_size &gt;= 8 &amp;&amp; IS_POWER_OF_2</li>
<li>注意最后一行，将 hash 值映射到数组上</li>
</ul>
<h5 id="if-ix-DKIX-EMPTY"><a href="#if-ix-DKIX-EMPTY" class="headerlink" title="if ix == DKIX_EMPTY"></a>if ix == DKIX_EMPTY</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> Py_ssize_t</span><br><span class="line">lookdict(PyDictObject *mp, PyObject *key,</span><br><span class="line">         Py_hash_t hash, PyObject ***value_addr, Py_ssize_t *hashpos)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">/* lookup indices.  returns DKIX_EMPTY, DKIX_DUMMY, or ix &gt;=0 */</span></span><br><span class="line">    ix = dk_get_index(dk, i);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ix == DKIX_EMPTY) &#123;</span><br><span class="line">        <span class="keyword">if</span> (hashpos != <span class="literal">NULL</span>)</span><br><span class="line">            *hashpos = i;</span><br><span class="line">        *value_addr = <span class="literal">NULL</span>;</span><br><span class="line">        <span class="keyword">return</span> DKIX_EMPTY;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如上，当 ix == DKIX_EMPTY 表明，slot 可用，直接返回。需要注意的是，返回之前，把 *value_addr 设为了 NULL，相当于清空了数据。</p>
<h5 id="if-ix-DKIX-EMPTY-1"><a href="#if-ix-DKIX-EMPTY-1" class="headerlink" title="if ix != DKIX_EMPTY"></a>if ix != DKIX_EMPTY</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">PyDictKeyEntry *ep0, *ep;</span><br><span class="line"></span><br><span class="line"><span class="comment">// DK_ENTRIES(keys)[index] if index &gt;= 0</span></span><br><span class="line">ep0 = DK_ENTRIES(dk);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (ix == DKIX_DUMMY) &#123;</span><br><span class="line">    freeslot = i;    <span class="comment">// 伪删除，me_value==NULL</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line">    ep = &amp;ep0[ix];</span><br><span class="line">    assert(ep-&gt;me_key != <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">if</span> (ep-&gt;me_key == key) &#123;    <span class="comment">// 引用相同</span></span><br><span class="line">        *value_addr = &amp;ep-&gt;me_value;</span><br><span class="line">        <span class="keyword">if</span> (hashpos != <span class="literal">NULL</span>)</span><br><span class="line">            *hashpos = i;</span><br><span class="line">        <span class="keyword">return</span> ix;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (ep-&gt;me_hash == hash) &#123;  <span class="comment">// hash 相同</span></span><br><span class="line">        startkey = ep-&gt;me_key;</span><br><span class="line">        Py_INCREF(startkey);</span><br><span class="line">        cmp = PyObject_RichCompareBool(startkey, key, Py_EQ);</span><br><span class="line">        <span class="comment">/* cmp = startkey == key ? 1 : 0 or -1 (raise ERROR) */</span></span><br><span class="line">        Py_DECREF(startkey);</span><br><span class="line">        <span class="keyword">if</span> (cmp &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            *value_addr = <span class="literal">NULL</span>;</span><br><span class="line">            <span class="keyword">return</span> DKIX_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (dk == mp-&gt;ma_keys &amp;&amp; ep-&gt;me_key == startkey) &#123;</span><br><span class="line">            <span class="keyword">if</span> (cmp &gt; <span class="number">0</span>) &#123;    <span class="comment">// 值相同</span></span><br><span class="line">                *value_addr = &amp;ep-&gt;me_value;</span><br><span class="line">                <span class="keyword">if</span> (hashpos != <span class="literal">NULL</span>)</span><br><span class="line">                    *hashpos = i;</span><br><span class="line">                <span class="keyword">return</span> ix;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">/* The dict was mutated, restart */</span></span><br><span class="line">            <span class="keyword">goto</span> top;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    freeslot = <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如上，当 ix == DKIX_DUMMY 时，将 freeslot 设置为该 slot。若后续搜索没有成功找到，那么将返回该 slot。</p>
<p>当 ix&gt;=0 &amp;&amp; ix != DKIX_DUMMY 时，获取 Entry 对象，对其值进行判断。前面已经知道，me_hash 是 hash(me_key) 的 缓存。</p>
<p>接着两个 if 判断，是为了优先考虑引用相同，接着再考虑引用不同而值相同。因为 Python 内部存在对象缓冲池，小整数，字符串等具有相同的对象引用，而对于1024等大整数，就必须判断 引用不一样而值一样。</p>
<p>PyObject_RichCompareBool 是传入操作数与操作符，返回数值。</p>
<ul>
<li>若cmp==1，即 hash,value 都相等，正确返回。</li>
<li>若cmp==0，即 hash相等，值不等，即 hash 冲突。</li>
</ul>
<h4 id="解决-hash-冲突"><a href="#解决-hash-冲突" class="headerlink" title="解决 hash 冲突"></a>解决 hash 冲突</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">执行循环的 前提条件：</span></span><br><span class="line"><span class="comment">if ix == DKIX_DUMMY：</span></span><br><span class="line"><span class="comment">    freeslot = i</span></span><br><span class="line"><span class="comment">elif ix&gt;=0 and hash冲突:</span></span><br><span class="line"><span class="comment">    freeslot = -1;</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PERTURB_SHIFT 5</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">size_t</span> perturb = hash;;) &#123;</span><br><span class="line">    <span class="comment">// 探测链算法</span></span><br><span class="line">    perturb &gt;&gt;= PERTURB_SHIFT;</span><br><span class="line">    i = ((i &lt;&lt; <span class="number">2</span>) + i + perturb + <span class="number">1</span>) &amp; mask;</span><br><span class="line">    ix = dk_get_index(dk, i);</span><br><span class="line">    <span class="keyword">if</span> (ix == DKIX_EMPTY) &#123;</span><br><span class="line">        <span class="keyword">if</span> (hashpos != <span class="literal">NULL</span>) &#123;</span><br><span class="line">            *hashpos = (freeslot == <span class="number">-1</span>) ? (Py_ssize_t)i : freeslot;</span><br><span class="line">            <span class="comment">/* 找到一个 UnusedEnpty，表明搜索失败</span></span><br><span class="line"><span class="comment">                1. freeslot 不存在，返回现在的</span></span><br><span class="line"><span class="comment">                2. freeslot 已经有一个，返回第一个</span></span><br><span class="line"><span class="comment">            */</span></span><br><span class="line">        &#125;</span><br><span class="line">        *value_addr = <span class="literal">NULL</span>;</span><br><span class="line">        <span class="keyword">return</span> ix;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (ix == DKIX_DUMMY) &#123;    <span class="comment">// 探测链 继续寻找</span></span><br><span class="line">        <span class="keyword">if</span> (freeslot == <span class="number">-1</span>)</span><br><span class="line">            freeslot = i;</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ep = &amp;ep0[ix];</span><br><span class="line">    assert(ep-&gt;me_key != <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">if</span> (ep-&gt;me_key == key) &#123;    <span class="comment">// 引用相同</span></span><br><span class="line">        <span class="keyword">if</span> (hashpos != <span class="literal">NULL</span>) &#123;</span><br><span class="line">            *hashpos = i;</span><br><span class="line">        &#125;</span><br><span class="line">        *value_addr = &amp;ep-&gt;me_value;</span><br><span class="line">        <span class="keyword">return</span> ix;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (ep-&gt;me_hash == hash) &#123;</span><br><span class="line">        startkey = ep-&gt;me_key;</span><br><span class="line">        Py_INCREF(startkey);</span><br><span class="line">        cmp = PyObject_RichCompareBool(startkey, key, Py_EQ);</span><br><span class="line">        Py_DECREF(startkey);</span><br><span class="line">        <span class="keyword">if</span> (cmp &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            *value_addr = <span class="literal">NULL</span>;</span><br><span class="line">            <span class="keyword">return</span> DKIX_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (dk == mp-&gt;ma_keys &amp;&amp; ep-&gt;me_key == startkey) &#123;</span><br><span class="line">            <span class="keyword">if</span> (cmp &gt; <span class="number">0</span>) &#123;    <span class="comment">// 值相同</span></span><br><span class="line">                <span class="keyword">if</span> (hashpos != <span class="literal">NULL</span>) &#123;</span><br><span class="line">                    *hashpos = i;</span><br><span class="line">                &#125;</span><br><span class="line">                *value_addr = &amp;ep-&gt;me_value;</span><br><span class="line">                <span class="keyword">return</span> ix;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">/* The dict was mutated, restart */</span></span><br><span class="line">            <span class="keyword">goto</span> top;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如上，整个过程是，当发生冲突时，再次计算获取一个 i 值，最终返回 NUll 或 目标值。</p>
<h3 id="SetItem"><a href="#SetItem" class="headerlink" title="SetItem"></a>SetItem</h3><h4 id="dict-ass-sub"><a href="#dict-ass-sub" class="headerlink" title="dict_ass_sub"></a>dict_ass_sub</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// dictobject.c.2163</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">int</span></span><br><span class="line">dict_ass_sub(PyDictObject *mp, PyObject *v, PyObject *w)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (w == <span class="literal">NULL</span>)</span><br><span class="line">        <span class="keyword">return</span> PyDict_DelItem((PyObject *)mp, v);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="keyword">return</span> PyDict_SetItem((PyObject *)mp, v, w);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// dictobject.c.1554</span></span><br><span class="line"><span class="keyword">int</span></span><br><span class="line">PyDict_SetItem(PyObject *op, PyObject *key, PyObject *value)</span><br><span class="line">&#123;</span><br><span class="line">    PyDictObject *mp;</span><br><span class="line">    Py_hash_t hash;</span><br><span class="line">    <span class="comment">// 类型检查</span></span><br><span class="line">    <span class="keyword">if</span> (!PyDict_Check(op)) &#123;</span><br><span class="line">        PyErr_BadInternalCall();</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    assert(key);</span><br><span class="line">    assert(value);</span><br><span class="line">    mp = (PyDictObject *)op;</span><br><span class="line">    <span class="comment">// 获取 hash 值</span></span><br><span class="line">    <span class="keyword">if</span> (!PyUnicode_CheckExact(key) ||</span><br><span class="line">        (hash = ((PyASCIIObject *) key)-&gt;hash) == <span class="number">-1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        hash = PyObject_Hash(key);</span><br><span class="line">        <span class="keyword">if</span> (hash == <span class="number">-1</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* insertdict() handles any resizing that might be necessary */</span></span><br><span class="line">    <span class="keyword">return</span> insertdict(mp, key, hash, value);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>执行 dict[item] = value 时，调用 dict_ass_sub()。<br>如上，与 List 类似，SetItem 和 DelItem 都是调用同一个方法。在 PyDict_SetItem 中，仅进行类型检查，计算 hash 值，实际插入调用 insertdict。</p>
<h4 id="insertdict"><a href="#insertdict" class="headerlink" title="insertdict"></a>insertdict</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// dictobject.c.1110</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">int</span></span><br><span class="line">insertdict(PyDictObject *mp, PyObject *key, Py_hash_t hash, PyObject *value)</span><br><span class="line">&#123;</span><br><span class="line">    PyObject *old_value;</span><br><span class="line">    PyObject **value_addr;</span><br><span class="line">    PyDictKeyEntry *ep, *ep0;</span><br><span class="line">    Py_ssize_t hashpos, ix;</span><br><span class="line"></span><br><span class="line">    Py_INCREF(key);</span><br><span class="line">    Py_INCREF(value);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// split-table 插入 key(not Unicode)</span></span><br><span class="line">    <span class="keyword">if</span> (mp-&gt;ma_values != <span class="literal">NULL</span> &amp;&amp; !PyUnicode_CheckExact(key)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (insertion_resize(mp) &lt; <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">goto</span> Fail;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 计算 ix 的值 ix = ?</span></span><br><span class="line">    ix = mp-&gt;ma_keys-&gt;dk_lookup(mp, key, hash, &amp;value_addr, &amp;hashpos);</span><br><span class="line">    <span class="keyword">if</span> (ix == DKIX_ERROR)</span><br><span class="line">        <span class="keyword">goto</span> Fail;</span><br><span class="line"></span><br><span class="line">    assert(PyUnicode_CheckExact(key) || mp-&gt;ma_keys-&gt;dk_lookup == lookdict);</span><br><span class="line">    MAINTAIN_TRACKING(mp, key, value);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// split-table 插入 key(different order)</span></span><br><span class="line">    <span class="keyword">if</span> (_PyDict_HasSplitTable(mp) &amp;&amp;</span><br><span class="line">        ((ix &gt;= <span class="number">0</span> &amp;&amp; *value_addr == <span class="literal">NULL</span> &amp;&amp; mp-&gt;ma_used != ix) ||</span><br><span class="line">         (ix == DKIX_EMPTY &amp;&amp; mp-&gt;ma_used != mp-&gt;ma_keys-&gt;dk_nentries))) &#123;</span><br><span class="line">        <span class="keyword">if</span> (insertion_resize(mp) &lt; <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">goto</span> Fail;</span><br><span class="line">        find_empty_slot(mp, key, hash, &amp;value_addr, &amp;hashpos);</span><br><span class="line">        ix = DKIX_EMPTY;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Insert when ix == DKIX_EMPTY</span></span><br><span class="line">    <span class="keyword">if</span> (ix == DKIX_EMPTY) &#123;</span><br><span class="line">        <span class="comment">/* Insert into new slot. */</span></span><br><span class="line">        <span class="keyword">if</span> (mp-&gt;ma_keys-&gt;dk_usable &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">/* Need to resize. */</span></span><br><span class="line">            <span class="keyword">if</span> (insertion_resize(mp) &lt; <span class="number">0</span>)</span><br><span class="line">                <span class="keyword">goto</span> Fail;</span><br><span class="line">            find_empty_slot(mp, key, hash, &amp;value_addr, &amp;hashpos);</span><br><span class="line">        &#125;</span><br><span class="line">        ep0 = DK_ENTRIES(mp-&gt;ma_keys);</span><br><span class="line">        ep = &amp;ep0[mp-&gt;ma_keys-&gt;dk_nentries];</span><br><span class="line">        dk_set_index(mp-&gt;ma_keys, hashpos, mp-&gt;ma_keys-&gt;dk_nentries);</span><br><span class="line">        ep-&gt;me_key = key;</span><br><span class="line">        ep-&gt;me_hash = hash;</span><br><span class="line">        <span class="keyword">if</span> (mp-&gt;ma_values) &#123;</span><br><span class="line">            assert (mp-&gt;ma_values[mp-&gt;ma_keys-&gt;dk_nentries] == <span class="literal">NULL</span>);</span><br><span class="line">            mp-&gt;ma_values[mp-&gt;ma_keys-&gt;dk_nentries] = value;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            ep-&gt;me_value = value;</span><br><span class="line">        &#125;</span><br><span class="line">        mp-&gt;ma_used++;</span><br><span class="line">        mp-&gt;ma_version_tag = DICT_NEXT_VERSION();</span><br><span class="line">        mp-&gt;ma_keys-&gt;dk_usable--;</span><br><span class="line">        mp-&gt;ma_keys-&gt;dk_nentries++;</span><br><span class="line">        assert(mp-&gt;ma_keys-&gt;dk_usable &gt;= <span class="number">0</span>);</span><br><span class="line">        assert(_PyDict_CheckConsistency(mp));</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    assert(value_addr != <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Insert when ix != DKIX_EMPTY</span></span><br><span class="line">    old_value = *value_addr;</span><br><span class="line">    <span class="keyword">if</span> (old_value != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        *value_addr = value;</span><br><span class="line">        mp-&gt;ma_version_tag = DICT_NEXT_VERSION();</span><br><span class="line">        assert(_PyDict_CheckConsistency(mp));</span><br><span class="line"></span><br><span class="line">        Py_DECREF(old_value); <span class="comment">/* which **CAN** re-enter (see issue #22653) */</span></span><br><span class="line">        Py_DECREF(key);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* pending state */</span></span><br><span class="line">    assert(_PyDict_HasSplitTable(mp));</span><br><span class="line">    assert(ix == mp-&gt;ma_used);</span><br><span class="line">    *value_addr = value;</span><br><span class="line">    mp-&gt;ma_used++;</span><br><span class="line">    mp-&gt;ma_version_tag = DICT_NEXT_VERSION();</span><br><span class="line">    assert(_PyDict_CheckConsistency(mp));</span><br><span class="line">    Py_DECREF(key);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">Fail:</span><br><span class="line">    Py_DECREF(value);</span><br><span class="line">    Py_DECREF(key);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如上，实际插入的对象的函数，代码也很长，需要分块处理。</p>
<h5 id="split-table-插入-key-not-Unicode"><a href="#split-table-插入-key-not-Unicode" class="headerlink" title="split-table 插入 key(not Unicode)"></a>split-table 插入 key(not Unicode)</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (mp-&gt;ma_values != <span class="literal">NULL</span> &amp;&amp; !PyUnicode_CheckExact(key)) &#123;</span><br><span class="line">    <span class="keyword">if</span> (insertion_resize(mp) &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">goto</span> Fail;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在 前面 PyDictObject 结构体定义中，有提到：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">A split table:</span><br><span class="line">    ma_values != NULL, dk_refcnt &gt;= 1</span><br><span class="line">    Values are stored in the ma_values array.</span><br><span class="line">    Only string (unicode) keys are allowed.</span><br></pre></td></tr></table></figure></p>
<p>当，split table 插入的 key 不是 Unicode 时，调用 insertion_resize。</p>
<h5 id="split-table-插入-key-different-order"><a href="#split-table-插入-key-different-order" class="headerlink" title="split-table 插入 key(different order)"></a>split-table 插入 key(different order)</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* When insertion order is different from shared key, we can't share</span></span><br><span class="line"><span class="comment"> * the key anymore.  Convert this instance to combine table.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">if</span> (_PyDict_HasSplitTable(mp) &amp;&amp;</span><br><span class="line">    ((ix &gt;= <span class="number">0</span> &amp;&amp; *value_addr == <span class="literal">NULL</span> &amp;&amp; mp-&gt;ma_used != ix) ||</span><br><span class="line">     (ix == DKIX_EMPTY &amp;&amp; mp-&gt;ma_used != mp-&gt;ma_keys-&gt;dk_nentries))) &#123;</span><br><span class="line">    <span class="keyword">if</span> (insertion_resize(mp) &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">goto</span> Fail;</span><br><span class="line">    find_empty_slot(mp, key, hash, &amp;value_addr, &amp;hashpos);</span><br><span class="line">    ix = DKIX_EMPTY;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在 前面 PyDictObject 结构体定义中，同时有提到：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">A split table:</span><br><span class="line">    All dicts sharing same key must have same insertion order.</span><br></pre></td></tr></table></figure></p>
<p>如源码中注释所述，当插入 顺序不一致时，将调用 insertion_resize。</p>
<h5 id="Insert-when-ix-DKIX-EMPTY"><a href="#Insert-when-ix-DKIX-EMPTY" class="headerlink" title="Insert when ix == DKIX_EMPTY"></a>Insert when ix == DKIX_EMPTY</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (ix == DKIX_EMPTY) &#123;</span><br><span class="line">    <span class="comment">/* Insert into new slot. */</span></span><br><span class="line">    <span class="keyword">if</span> (mp-&gt;ma_keys-&gt;dk_usable &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">/* Need to resize. */</span></span><br><span class="line">        <span class="keyword">if</span> (insertion_resize(mp) &lt; <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">goto</span> Fail;</span><br><span class="line">        find_empty_slot(mp, key, hash, &amp;value_addr, &amp;hashpos);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 初始化</span></span><br><span class="line">    ep0 = DK_ENTRIES(mp-&gt;ma_keys);</span><br><span class="line">    ep = &amp;ep0[mp-&gt;ma_keys-&gt;dk_nentries];</span><br><span class="line">    dk_set_index(mp-&gt;ma_keys, hashpos, mp-&gt;ma_keys-&gt;dk_nentries);</span><br><span class="line">    ep-&gt;me_key = key;</span><br><span class="line">    ep-&gt;me_hash = hash;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 插入不同地方</span></span><br><span class="line">    <span class="keyword">if</span> (mp-&gt;ma_values) &#123;</span><br><span class="line">        assert (mp-&gt;ma_values[mp-&gt;ma_keys-&gt;dk_nentries] == <span class="literal">NULL</span>);</span><br><span class="line">        mp-&gt;ma_values[mp-&gt;ma_keys-&gt;dk_nentries] = value;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        ep-&gt;me_value = value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 调整属性值</span></span><br><span class="line">    mp-&gt;ma_used++;</span><br><span class="line">    mp-&gt;ma_version_tag = DICT_NEXT_VERSION();</span><br><span class="line">    mp-&gt;ma_keys-&gt;dk_usable--;</span><br><span class="line">    mp-&gt;ma_keys-&gt;dk_nentries++;</span><br><span class="line">    assert(mp-&gt;ma_keys-&gt;dk_usable &gt;= <span class="number">0</span>);</span><br><span class="line">    assert(_PyDict_CheckConsistency(mp));</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如上，ix == DKIX_EMPTY 时，执行插入动作。</p>
<ol>
<li>if 可用空间 dk_usable &lt;=0，调用 insertion_resize</li>
<li>dk_set_index，初始化 me_key, me_hash</li>
<li>根据 ma_values，判断 table 类型，插入 不同的地方</li>
<li>调整 mp 自身属性</li>
</ol>
<h5 id="Insert-when-ix-DKIX-EMPTY-1"><a href="#Insert-when-ix-DKIX-EMPTY-1" class="headerlink" title="Insert when ix != DKIX_EMPTY"></a>Insert when ix != DKIX_EMPTY</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">assert(value_addr != <span class="literal">NULL</span>);</span><br><span class="line">old_value = *value_addr;</span><br><span class="line"><span class="keyword">if</span> (old_value != <span class="literal">NULL</span>) &#123;</span><br><span class="line">    *value_addr = value;</span><br><span class="line">    mp-&gt;ma_version_tag = DICT_NEXT_VERSION();</span><br><span class="line">    assert(_PyDict_CheckConsistency(mp));</span><br><span class="line"></span><br><span class="line">    Py_DECREF(old_value); <span class="comment">/* which **CAN** re-enter (see issue #22653) */</span></span><br><span class="line">    Py_DECREF(key);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* pending state */</span></span><br><span class="line">assert(_PyDict_HasSplitTable(mp));</span><br><span class="line">assert(ix == mp-&gt;ma_used);</span><br><span class="line">*value_addr = value;</span><br><span class="line">mp-&gt;ma_used++;</span><br><span class="line">mp-&gt;ma_version_tag = DICT_NEXT_VERSION();</span><br><span class="line">assert(_PyDict_CheckConsistency(mp));</span><br><span class="line">Py_DECREF(key);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br></pre></td></tr></table></figure>
<p>如上，ix != DKIX_EMPTY 即代表修改值。同时，根据 old_value 可以判断出 表的类型。</p>
<h3 id="PyDict-DelItem"><a href="#PyDict-DelItem" class="headerlink" title="PyDict_DelItem"></a>PyDict_DelItem</h3><p>前面已经提到 Del 和 Set 有相同的入口 dict_ass_sub。Del 最终实现是靠 PyDict_DelItem()<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// dictobject.c/1621</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">PyDict_DelItem</span><span class="params">(PyObject *op, PyObject *key)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Py_hash_t hash;</span><br><span class="line">    assert(key);</span><br><span class="line">    <span class="keyword">if</span> (!PyUnicode_CheckExact(key) ||</span><br><span class="line">        (hash = ((PyASCIIObject *) key)-&gt;hash) == <span class="number">-1</span>) &#123;</span><br><span class="line">        hash = PyObject_Hash(key);</span><br><span class="line">        <span class="keyword">if</span> (hash == <span class="number">-1</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> _PyDict_DelItem_KnownHash(op, key, hash);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>如上，先验证 hash，在调用 _PyDict_DelItem_KnownHash</p>
<h4 id="PyDict-DelItem-KnownHash"><a href="#PyDict-DelItem-KnownHash" class="headerlink" title="_PyDict_DelItem_KnownHash"></a>_PyDict_DelItem_KnownHash</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span></span><br><span class="line">_PyDict_DelItem_KnownHash(PyObject *op, PyObject *key, Py_hash_t hash)</span><br><span class="line">&#123;</span><br><span class="line">    Py_ssize_t hashpos, ix;</span><br><span class="line">    PyDictObject *mp;</span><br><span class="line">    PyObject **value_addr;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!PyDict_Check(op)) &#123;</span><br><span class="line">        PyErr_BadInternalCall();</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    assert(key);</span><br><span class="line">    assert(hash != <span class="number">-1</span>);</span><br><span class="line">    mp = (PyDictObject *)op;</span><br><span class="line">    ix = (mp-&gt;ma_keys-&gt;dk_lookup)(mp, key, hash, &amp;value_addr, &amp;hashpos);</span><br><span class="line">    <span class="keyword">if</span> (ix == DKIX_ERROR)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">if</span> (ix == DKIX_EMPTY || *value_addr == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        _PyErr_SetKeyError(key);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    assert(dk_get_index(mp-&gt;ma_keys, hashpos) == ix);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Split table doesn't allow deletion.  Combine it.</span></span><br><span class="line">    <span class="keyword">if</span> (_PyDict_HasSplitTable(mp)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (dictresize(mp, DK_SIZE(mp-&gt;ma_keys))) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        ix = (mp-&gt;ma_keys-&gt;dk_lookup)(mp, key, hash, &amp;value_addr, &amp;hashpos);</span><br><span class="line">        assert(ix &gt;= <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> delitem_common(mp, hashpos, ix, value_addr);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如上，_PyDict_DelItem_KnownHash 代码很好理解，根据 key hash 找到相应的 enrty。<br>需要注意的是其中的，Split-table 不允许删除操作，必然要转换为 combined table。</p>
<h4 id="delitem-common"><a href="#delitem-common" class="headerlink" title="delitem_common"></a>delitem_common</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">int</span></span><br><span class="line">delitem_common(PyDictObject *mp, Py_ssize_t hashpos, Py_ssize_t ix,</span><br><span class="line">               PyObject **value_addr)</span><br><span class="line">&#123;</span><br><span class="line">    PyObject *old_key, *old_value;</span><br><span class="line">    PyDictKeyEntry *ep;</span><br><span class="line"></span><br><span class="line">    old_value = *value_addr;</span><br><span class="line">    assert(old_value != <span class="literal">NULL</span>);</span><br><span class="line">    *value_addr = <span class="literal">NULL</span>;</span><br><span class="line">    mp-&gt;ma_used--;</span><br><span class="line">    mp-&gt;ma_version_tag = DICT_NEXT_VERSION();</span><br><span class="line">    ep = &amp;DK_ENTRIES(mp-&gt;ma_keys)[ix];</span><br><span class="line">    dk_set_index(mp-&gt;ma_keys, hashpos, DKIX_DUMMY);</span><br><span class="line">    ENSURE_ALLOWS_DELETIONS(mp);</span><br><span class="line">    old_key = ep-&gt;me_key;</span><br><span class="line">    ep-&gt;me_key = <span class="literal">NULL</span>;</span><br><span class="line">    Py_DECREF(old_key);</span><br><span class="line">    Py_DECREF(old_value);</span><br><span class="line"></span><br><span class="line">    assert(_PyDict_CheckConsistency(mp));</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如上，代码很简单。。就酱。。</p>
<h2 id="insertion-resize"><a href="#insertion-resize" class="headerlink" title="insertion_resize"></a>insertion_resize</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// dictobject.c.1099</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">int</span></span><br><span class="line">insertion_resize(PyDictObject *mp)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> dictresize(mp, GROWTH_RATE(mp));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>前面，已经提到，在 CRUD 时，有几种情况下会调用 insertion_resize</p>
<ul>
<li>dk_usable &lt;=0</li>
<li>split-table insert key which is not Unicode.</li>
<li>split-table insertion order is different from shared key.</li>
</ul>
<h3 id="GROWTH-RATE"><a href="#GROWTH-RATE" class="headerlink" title="GROWTH_RATE"></a>GROWTH_RATE</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> GROWTH_RATE(d) (((d)-&gt;ma_used*2)+((d)-&gt;ma_keys-&gt;dk_size&gt;&gt;1))</span></span><br></pre></td></tr></table></figure>
<p>如上，在调用 dictresize 之前，会先计算一个 GROWTH_RATE。这个东西的作用可以参考<a href="http://nagisa.co/2017/08/08/%E3%80%8APython%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90%E3%80%8B%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B013/" target="_blank" rel="noopener">链接已失效</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">如果原有的数据量小于原有大小的1/4，那么它也会小于现有大小的1/4，但新的dict缩小了；</span><br><span class="line">如果原有的数据量大于原有大小的1/4，那么它也会大于现有大小的1/4，但新的dict扩大了。</span><br><span class="line"></span><br><span class="line">if used &lt; size/4:</span><br><span class="line">    used*4  &lt; used*2 + size/4*2 = used*2 + size/2 = newsize</span><br><span class="line">    used    &lt; newsize/4</span><br><span class="line">    newsize = used*2 + size/2   &lt; size/4*2 + size/2 = size</span><br><span class="line"></span><br><span class="line">if used &gt; size/4:</span><br><span class="line">    used*4  &gt; used*2 + size/4*2 = used*2 + size/2 = newsize</span><br><span class="line">    used    &gt; newsize/4</span><br><span class="line">    newsize = used*2 + size/2  &gt; size/4*2 + size/2 = size</span><br></pre></td></tr></table></figure>
<p>emmm…好吧，看看就好</p>
<h3 id="dictresize"><a href="#dictresize" class="headerlink" title="dictresize"></a>dictresize</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// dictobject.c.1250</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">    Restructure the table by allocating a new table and reinserting all</span></span><br><span class="line"><span class="comment">    items again.  When entries have been deleted, the new table may</span></span><br><span class="line"><span class="comment">    actually be smaller than the old one.</span></span><br><span class="line"><span class="comment">    If a table is split (its keys and hashes are shared, its values are not),</span></span><br><span class="line"><span class="comment">    then the values are temporarily copied into the table, it is resized as</span></span><br><span class="line"><span class="comment">    a combined table, then the me_value slots in the old table are NULLed out.</span></span><br><span class="line"><span class="comment">    After resizing a table is always combined,</span></span><br><span class="line"><span class="comment">    but can be resplit by make_keys_shared().</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">int</span></span><br><span class="line">dictresize(PyDictObject *mp, Py_ssize_t minsize)</span><br><span class="line">        ...    <span class="comment">// 很多很多</span></span><br><span class="line">    <span class="comment">/* Allocate a new table. */</span></span><br><span class="line">    <span class="comment">// 注：static PyDictKeysObject *new_keys_object(Py_ssize_t size)</span></span><br><span class="line">    mp-&gt;ma_keys = new_keys_object(newsize);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Main loop */</span></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; oldkeys-&gt;dk_nentries; i++) &#123;</span><br><span class="line">        PyDictKeyEntry *ep = &amp;ep0[i];</span><br><span class="line">        <span class="keyword">if</span> (ep-&gt;me_value != <span class="literal">NULL</span>) &#123;</span><br><span class="line">            insertdict_clean(mp, ep-&gt;me_key, ep-&gt;me_hash, ep-&gt;me_value);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">        ...    <span class="comment">// 很多很多</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">    Internal routine used by dictresize() to insert an item which is</span></span><br><span class="line"><span class="comment">    known to be absent from the dict.  This routine also assumes that</span></span><br><span class="line"><span class="comment">    the dict contains no deleted entries.</span></span><br><span class="line"><span class="comment">    Besides the performance benefit,</span></span><br><span class="line"><span class="comment">    using insertdict() in dictresize() is dangerous (SF bug #1456209).</span></span><br><span class="line"><span class="comment">    Note that no refcounts are changed by this routine;</span></span><br><span class="line"><span class="comment">    if needed, the caller is responsible for incref'ing `key` and `value`.</span></span><br><span class="line"><span class="comment">    Neither mp-&gt;ma_used nor k-&gt;dk_usable are modified by this routine;</span></span><br><span class="line"><span class="comment">    the caller must set them correctly</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span></span><br><span class="line">insertdict_clean(PyDictObject *mp, PyObject *key, Py_hash_t hash,</span><br><span class="line">                 PyObject *value)</span><br></pre></td></tr></table></figure>
<p>emm…代码很长，看注释就够了。</p>
<ul>
<li>dictresize 返回的都是 combined table，跟上文一致</li>
<li>combined split 两者是可以相互转换的</li>
<li>resize 后，表是可以被 扩容或缩小的</li>
<li>insertdict_clean 只干插入的活，不干其他的</li>
<li>只要涉及到 resize ，就涉及到 Malloc memcpy，耗时 耗力</li>
</ul>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/CPython3-6源码/" rel="tag"># CPython3.6源码</a>
          
            <a href="/tags/PyDictObject/" rel="tag"># PyDictObject</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/07/15/1.3.Python列表对象/" rel="next" title="【CPython3.6源码分析】PyListObject">
                <i class="fa fa-chevron-left"></i> 【CPython3.6源码分析】PyListObject
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2018/07/21/1.5.Python Code Frame/" rel="prev" title="【CPython3.6源码分析】PyCodeObject/PyFrameObject">
                【CPython3.6源码分析】PyCodeObject/PyFrameObject <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  
    <div class="comments" id="comments">
      <div id="disqus_thread">
        <noscript>
          Please enable JavaScript to view the
          <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a>
        </noscript>
      </div>
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="https://avatars3.githubusercontent.com/u/41121010?s=460&v=4"
                alt="He11oLx" />
            
              <p class="site-author-name" itemprop="name">He11oLx</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">10</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">2</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">11</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#参考"><span class="nav-number">1.</span> <span class="nav-text">参考</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Interface"><span class="nav-number">2.</span> <span class="nav-text">Interface</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#PyDict-Type"><span class="nav-number">3.</span> <span class="nav-text">PyDict_Type</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#PyDictObject"><span class="nav-number">4.</span> <span class="nav-text">PyDictObject</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#PyDictKeysObject"><span class="nav-number">5.</span> <span class="nav-text">PyDictKeysObject</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#layout"><span class="nav-number">5.1.</span> <span class="nav-text">layout</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#PyDictKeyEntry"><span class="nav-number">5.2.</span> <span class="nav-text">PyDictKeyEntry</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#dk-indices"><span class="nav-number">5.3.</span> <span class="nav-text">dk_indices</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#创建"><span class="nav-number">6.</span> <span class="nav-text">创建</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#new-keys-object"><span class="nav-number">6.1.</span> <span class="nav-text">new_keys_object</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#new-dict"><span class="nav-number">6.2.</span> <span class="nav-text">new_dict</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#共享机制"><span class="nav-number">7.</span> <span class="nav-text">共享机制</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#dict-dealloc"><span class="nav-number">7.1.</span> <span class="nav-text">dict_dealloc</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#CRUD"><span class="nav-number">8.</span> <span class="nav-text">CRUD</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Mapping方法簇"><span class="nav-number">8.1.</span> <span class="nav-text">Mapping方法簇</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#GetItem"><span class="nav-number">8.2.</span> <span class="nav-text">GetItem</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#dk-lookup"><span class="nav-number">8.2.1.</span> <span class="nav-text">dk_lookup</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#lookdict"><span class="nav-number">8.2.2.</span> <span class="nav-text">lookdict</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#ix"><span class="nav-number">8.2.2.1.</span> <span class="nav-text">ix = ?</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#if-ix-DKIX-EMPTY"><span class="nav-number">8.2.2.2.</span> <span class="nav-text">if ix == DKIX_EMPTY</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#if-ix-DKIX-EMPTY-1"><span class="nav-number">8.2.2.3.</span> <span class="nav-text">if ix != DKIX_EMPTY</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#解决-hash-冲突"><span class="nav-number">8.2.3.</span> <span class="nav-text">解决 hash 冲突</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#SetItem"><span class="nav-number">8.3.</span> <span class="nav-text">SetItem</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#dict-ass-sub"><span class="nav-number">8.3.1.</span> <span class="nav-text">dict_ass_sub</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#insertdict"><span class="nav-number">8.3.2.</span> <span class="nav-text">insertdict</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#split-table-插入-key-not-Unicode"><span class="nav-number">8.3.2.1.</span> <span class="nav-text">split-table 插入 key(not Unicode)</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#split-table-插入-key-different-order"><span class="nav-number">8.3.2.2.</span> <span class="nav-text">split-table 插入 key(different order)</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Insert-when-ix-DKIX-EMPTY"><span class="nav-number">8.3.2.3.</span> <span class="nav-text">Insert when ix == DKIX_EMPTY</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Insert-when-ix-DKIX-EMPTY-1"><span class="nav-number">8.3.2.4.</span> <span class="nav-text">Insert when ix != DKIX_EMPTY</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#PyDict-DelItem"><span class="nav-number">8.4.</span> <span class="nav-text">PyDict_DelItem</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#PyDict-DelItem-KnownHash"><span class="nav-number">8.4.1.</span> <span class="nav-text">_PyDict_DelItem_KnownHash</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#delitem-common"><span class="nav-number">8.4.2.</span> <span class="nav-text">delitem_common</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#insertion-resize"><span class="nav-number">9.</span> <span class="nav-text">insertion_resize</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#GROWTH-RATE"><span class="nav-number">9.1.</span> <span class="nav-text">GROWTH_RATE</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#dictresize"><span class="nav-number">9.2.</span> <span class="nav-text">dictresize</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">He11oLx</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Pisces</a></div>




        
<div class="busuanzi-count">
  <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  

  
</div>








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="https://cdn.bootcss.com/jquery/2.1.3/jquery.min.js"></script>
  

  
  
    <script type="text/javascript" src="https://cdn.bootcss.com/fastclick/1.0.6/fastclick.min.js"></script>
  

  
  
    <script type="text/javascript" src="https://cdn.bootcss.com/jquery_lazyload/1.9.7/jquery.lazyload.min.js"></script>
  

  
  
    <script type="text/javascript" src="https://cdn.bootcss.com/velocity/1.2.1/velocity.min.js"></script>
  

  
  
    <script type="text/javascript" src="https://cdn.bootcss.com/velocity/1.2.1/velocity.ui.min.js"></script>
  

  
  
    <script type="text/javascript" src="https://cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.min.js"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  

    
      <script id="dsq-count-scr" src="https://he11olx.disqus.com/count.js" async></script>
    

    
      <script type="text/javascript">
        var disqus_config = function () {
          this.page.url = 'http://he11olx.com/2018/07/15/1.4.Python字典对象/';
          this.page.identifier = '2018/07/15/1.4.Python字典对象/';
          this.page.title = '【CPython3.6源码分析】PyDictObject';
        };
        var d = document, s = d.createElement('script');
        s.src = 'https://he11olx.disqus.com/embed.js';
        s.setAttribute('data-timestamp', '' + +new Date());
        (d.head || d.body).appendChild(s);
      </script>
    

  




	





  














  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  
  

  

  

  

</body>
</html>
